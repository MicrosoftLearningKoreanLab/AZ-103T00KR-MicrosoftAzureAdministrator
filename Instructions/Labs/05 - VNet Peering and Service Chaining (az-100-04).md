---
lab:
    title: 'VNet 피어링 및 서비스 체인'
    module: '모듈 05 - 사이트간 연결'
---

# 랩: VNet 피어링 및 서비스 체인
  
이 랩의 모든 작업은 연습 2 작업 3, 연습 3 작업 1 및 작업 2를 제외한 Azure 포털에서 수행되며, 여기에는 원격 데스크톱 세션에서 Azure VM까지 수행된 단계가 포함됩니다.

랩 파일: 

-  **Labfiles\\Module_05\\VNet_Peering_and_Service_Chaining\\az-100-04_01_azuredeploy.json**

-  **Labfiles\\Module_05\\VNet_Peering_and_Service_Chaining\\az-100-04_02_azuredeploy.json**

-  **Labfiles\\Module_05\\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**

### 시나리오
  
Adatum Corporation은 Azure 구독에서 Azure 가상 네트워크 간의 서비스 체인을 구현하려고 합니다. 


### 목표
  
이 과정을 완료하면 다음과 같은 역량을 갖추게 됩니다:

- Azure Resource Manager 템플릿을 사용하여 Azure 가상 네트워크를 만들고 Azure VM을 배포합니다.

- VNet 피어링을 구성합니다.

- 사용자 지정 라우팅 구현

- 서비스 체인의 유효성 검사


### 연습 0: Azure 환경 준비
  
이 연습의 주요 작업은 다음과 같습니다:

1. Azure Resource Manager 템플릿을 사용하여 두 개의 Azure VM을 호스팅하는 첫 번째 가상 네트워크 만들기

1. Azure Resource Manager 템플릿을 사용하여 단일 Azure VM을 호스팅하는 동일한 지역에서 두 번째 가상 네트워크 만들기

#### 작업 1: Azure Resource Manager 템플릿을 사용하여 두 개의 Azure VM을 호스팅하는 첫 번째 가상 네트워크 만들기

1. 랩 가상 머신에서 Microsoft Edge를 시작하고 [**http://portal.azure.com**](http://portal.azure.com) 에서 Azure 포털을 찾아보고 이 랩에서 사용하려는 Azure 구독에서 소유자 역할이 있는 Microsoft 계정을 사용하여 로그인합니다.

1. Azure 포털에서 **리소스 만들기** 블레이드로 이동합니다.

1. **리소스 만들기** 블레이드가 뜨면, Azure 마켓플레이스에서 **Template deployment**를 검색합니다. 그리고 **Template deployment (deploy using custom templates)**를 선택합니다.

1. **만들기**를 클릭합니다.

1. **사용자 지정 배포** 블레이드에서 **편집기에서 사용자 고유의 템플릿을 빌드합니다.** 를 선택합니다.

1. **템플릿 편집** 블레이드에서 템플릿 파일인 **Labfiles\\Module_05\\VNet_Peering_and_Service_Chaining\\az-100-04_01_azuredeploy.json** 을 로드합니다. 

   > **참고**: 템플릿의 내용을 검토하고 Windows Server 2016 데이터 센터를 호스팅하는 Azure VM의 배포를 정의합니다.

1. 템플릿을 저장하고 **사용자 지정 배포** 블레이드로 돌아갑니다. 

1. **사용자 지정 배포** 블레이드에서 **매개 변수 편집** 블레이드로 이동합니다.

1. **편집 매개 변수** 블레이드에서 매개 변수 파일 **Labfiles\\Module_05\\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**을 로드합니다. 

1. 매개 변수를 저장하고 **사용자 지정 배포** 블레이드로 돌아갑니다. 

1. **사용자 지정 배포** 블레이드에서 다음 설정을 사용하고 템플릿 배포를 시작합니다.

    - 구독: 이 랩에서 사용 중인 구독의 이름

    - 리소스 그룹: **az1000401-RG** 이름으로 새로 만들기

    - 지역: 랩 위치에 가장 가까운 Azure 지역의 이름 및 Azure VM을 프로비전할 수 있는 지역

    - Vm Size: **Standard_D2s_v3**

    - Vm1Name: **az1000401-vm1**

    - Vm2Name: **az1000401-vm2**

    - Admin Username: **Student**

    - Admin Password: **Pa55w.rd1234**

    - Virtual Network Name: **az1000401-vnet1**

   > **참고**: Azure VM을 프로비전할 수 있는 Azure 지역을 식별하려면 [**https://azure.microsoft.com/ko-kr/regions/offers/**](https://azure.microsoft.com/ko-kr/regions/offers/)참고하십시오.

   > **참고**: 배포가 완료될 때까지 기다리지 말고 다음 작업으로 진행합니다. 이 랩의 두 번째 연습에서는 이 배포에 포함된 네트워크 및 가상 머신를 사용합니다.


#### 작업 2: Azure Resource Manager 템플릿을 사용하여 단일 Azure VM을 호스팅하는 동일한 지역에서 두 번째 가상 네트워크 만들기

1. Azure 포털에서 **리소스 만들기** 블레이드로 이동합니다.

1. **리소스 만들기** 블레이드가 뜨면, Azure 마켓플레이스에서 **Template deployment**를 검색합니다. 그리고 **Template deployment (deploy using custom templates)**를 선택합니다.

1. **만들기**를 클릭합니다.

1. **사용자 지정 배포** 블레이드에서 **편집기에서 사용자 고유의 템플릿을 빌드합니다.** 를 선택합니다.

1. **템플릿 편집** 블레이드에서 템플릿 파일인 **Labfiles\\Module_05\\VNet_Peering_and_Service_Chaining\\az-100-04_02_azuredeploy.json** 을 로드합니다. 

   > **참고**: 템플릿의 내용을 검토하고 Windows Server 2016 데이터 센터를 호스팅하는 Azure VM의 배포를 정의합니다.

1. 템플릿을 저장하고 **사용자 지정 배포** 블레이드로 돌아갑니다. 

1. **사용자 지정 배포** 블레이드에서 **매개 변수 편집** 블레이드로 이동합니다.

1. **편집 매개 변수** 블레이드에서 매개 변수 파일 **Labfiles\\Module_05\\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json** 을 로드합니다. 

1. 매개 변수를 저장하고 **사용자 지정 배포** 블레이드로 돌아갑니다. 

1. **사용자 지정 배포** 블레이드에서 다음 설정을 사용하고 템플릿 배포를 시작합니다.

    - 구독: 이 랩에서 사용 중인 구독의 이름

    - 리소스 그룹: **az1000402-RG** 이름으로 새로 만들기

    - 지역: 이전 작업에서 선택한 Azure 지역의 이름

    - Vm Size: **Standard_D2s_v3**

    - VmName: **az1000402-vm3**

    - Admin Username: **Student**

    - Admin Password: **Pa55w.rd1234**

    - Virtual Network Name: **az1000402-vnet2**

   > **참고**: 배포가 완료될 때까지 기다리지 말고 다음 작업으로 진행합니다. 이 랩의 두 번째 연습에서는 이 배포에 포함된 네트워크 및 가상 머신를 사용합니다.

> **결과**: 이 연습을 완료한 후 Azure Resource Manager 템플릿을 사용하여 두 개의 Azure 가상 네트워크를 만들고 세 개의 Azure VM에 대한 배포를 시작했습니다.


### 연습 1: VNet 피어링 구성 

이 연습의 주요 작업은 다음과 같습니다:

1. 첫 번째 가상 네트워크와 두 번째 가상 네트워크에 대한 VNet 피어링 구성


#### 작업 1: 첫 번째 가상 네트워크와 두 번째 가상 네트워크에 대한 VNet 피어링 구성
  
1. Azure 포털에서 **az1000401-vnet1** 가상네트워크 블레이드로 이동합니다.

1. **az1000401-vnet1** 가상 네트워크 블레이드에서 **피어링** 블레이드로 이동합니다.

1. **az1000401-vnet1 - 피어링** 블레이드에서 **+ 추가**를 클릭하여 다음 설정으로 VNet 피어링을 만듭니다.

    - 이름: **az1000401-vnet1-to-az1000402-vnet2**

    - 가상 네트워크 배포 모델: **Resource Manager**

    - 구독: 이 랩에서 사용 중인 Azure 구독의 이름

    - 가상 네트워크: **az1000402-vnet2**

    - az1000402-vnet2에서 az1000401-vnet1(으)로 피어링 이름: **az1000402-vnet2-to-az1000401-vnet1**

    - az1000401-vnet1에서 az1000402-vnet2(으)로 가상 네트워크 액세스 설정 구성: **사용**

    - az1000401-vnet2에서 az1000402-vnet1(으)로 가상 네트워크 액세스 설정 구성: **사용**

    - az1000401-vnet2에서 az1000402-vnet1(으)로 전달되는 트래픽 설정 구성: **사용 안 함**

    - az1000401-vnet1에서 az1000402-vnet2(으)로 전달되는 트래픽 설정 구성: **사용 안 함**

    - 게이트웨이 전송 설정 구성: **사용 안 함**

> **결과**: 두 가상 네트워크 모두에 대한 관리 액세스 권한이 있으므로 포털은 한번의 조치로 양방향 (vnet1에서 vnet2로, vnet2에서 vnet1으로)피어링을 구성합니다. CLI, PowerShell 또는 REST API에서 이러한 작업은 독립적으로 수행해야합니다.


### 연습 2: 사용자 지정 라우팅 구현
  
이 연습의 주요 작업은 다음과 같습니다:

1. Azure VM의 네트워크 인터페이스에 대한 IP 전달 사용

1. 사용자 정의 라우팅 구성 

1. Windows 서버 2016을 실행하는 Azure VM에서 라우팅 구성


#### 작업 1: Azure VM의 네트워크 인터페이스에 대한 IP 전달 사용
  
   > **참고**: 이 작업을 시작하기 전에 연습 0에서 시작한 템플릿 배포가 완료되었는지 확인합니다. 

1. Azure 포털에서 두 번째 Azure VM **az1000401-vm2**의 블레이드로 이동합니다.

1. **az1000401-vm2** 블레이드 에서 **네트워킹** 블레이드로 이동합니다.

1. **az1000401-vm2 - 네트워킹** 블레이드에서 Azure VM의 네트워크 어댑터(**az1000401-nic2**)의 블레이드로 이동합니다.

1. **az1000401-nic2** 블레이드에서 **IP 구성** 블레이드로 이동합니다.

1. **az1000401-nic2 - IP 구성** 블레이드에서 **IP 전달** 을 활성화 합니다.

   > **참고**: 이 작업에서 구성한 네트워크 인터페이스인 Azure VM **az1000401-vm2** 는 라우터로 작동하여 두 가상 네트워크 간의 서비스 체인을 용이하게 합니다.


#### 작업 2: 사용자 정의 라우팅 구성 

1. Azure 포털에서 **리소스 만들기** 블레이드로 이동합니다.

1. **리소스 만들기** 블레이드가 뜨면, Azure 마켓플레이스에서 **Route table** 테이블을 검색합니다.

1. 검색 결과 목록을 사용하여 **경로 테이블 만들기** 블레이드로 이동합니다.

1. **경로 테이블 만들기** 블레이드에서 다음 설정을 사용하여 새 경로 테이블을 만듭니다.

    - 이름: **az1000402-rt1**

    - 구독: 이 랩에 사용하는 Azure 구독의 이름

    - 리소스 그룹: **az1000402-RG**

    - 지역: 가상 네트워크를 만든 동일한 Azure 지역
  
    - BGP 경로 전파: **사용 안 함**

1. Azure 포털에서 **az1000402-rt1** 블레이드로 이동합니다.

1. **az1000402-rt1** 블레이드에서 **경로** 블레이드로 이동합니다. 

1. **az1000402-rt1 - 경로** 블레이드에서 다음 설정을 사용하여 경로 테이블에 경로를 추가합니다. 

    - 경로 이름: **custom-route-to-az1000401-vnet1**

    - 주소 접두사: **10.104.0.0/16**

    - 다음 홉 유형: **가상 어플라이언스**

    - 다음 홉 주소: **10.104.1.4**

   > **참고**: **10.104.1.4** 는 **az1000401-vm2** 의 네트워크 인터페이스의 IP주소로, 두 가상 네트워크 간에 서비스 체인을 제공합니다.

1. **az1000402-rt1** 블레이드에서 **서브넷** 블레이드로 이동합니다. 

1. **az1000402-rt1 - 서브넷** 블레이드에서 경로 테이블 **az1000402-rt1** 을 **az1000402-vnet2** 의 **subnet0** 과 연결합니다.


#### 작업 3: Windows 서버 2016을 실행하는 Azure VM에서 라우팅 구성

1. Azure 포털에서 **az1000401-vm2** Azure VM의 블레이드로 이동합니다. 

1. **az1000401-vm2** 블레이드의 **개요** 창에서 RDP 파일을 생성하고 **az1000401-vm2** 에 연결하는 데 사용합니다.

1. 메시지가 표시되면 다음 자격 증명을 지정하여 인증합니다:

    - 사용자 이름: **Student**

    - 암호: **Pa55w.rd1234**

1. **az1000401-vm2** 에 대한 원격 데스크톱 세션 내에서 **서버 관리자**의 **관리**를 클릭하고 **역할 및 기능 추가 마법사** 를 선택한다.

1. **다음**을 두번 클릭하고 **az1000401-vm2**가 선택된 것을 확인한 후 **다음**을 클릭한다. **원격 엑세스** 서버 역할을 추가한 후 **다음**을 세번 클릭한다. **라우팅**롤 서비스를 선택한다. **기능 추가**를 클릭한다. **다음**을 세번 클릭한 후 **설치**를 클릭한다. 설치가 완료되면 **닫기**를 클릭한다.

   > **참고**: **이 컴퓨터와 대상 서버 또는 VHD 간에 버전 불일치가 있을 수 있습니다.** 라는 오류 메시지가 발생하면 **역할 및 기능 추가 마법사**의 **서버 역할** 페이지에서 **원격 엑세스** 확인란의 선택을 취소하고 **다음** 을 클릭하고 **이전** 을 다시 클릭한 후 **원격 액세스** 확인란을 다시 선택합니다.

1. 서버 관리자에서 **az1000401-vm2** 에 원격 데스크톱 세션 내에서 **라우팅 및 원격 액세스** 콘솔을 시작합니다. 

1. **라우팅 및 원격 액세스** 콘솔에서 **라우팅 및 원격 액세스 설정 및 활성화**를 실행하고, **사용자 지정 구성** 옵션을 사용하고, **LAN 라우팅** 을 활성화하고, **라우팅 및 원격 액세스** 서비스를 시작합니다.

1. **az1000401-vm2** 에 대한 원격 데스크톱 세션 내에서 **고급 보안 콘솔을 사용하여 Windows 방화벽** 을 시작하고 모든 프로필에 대해 **파일 및 프린터 공유(에코 요청 - ICMPv4-In)** 인바운드 규칙을 사용하도록 설정합니다.

> **결과**: 이 연습을 완료한 후 피어있는 Azure 가상 네트워크 간에 사용자 지정 라우팅을 구현했습니다. 


### 연습 3: 서비스 체인 유효성 검사

이 연습의 주요 작업은 다음과 같습니다:

1. 대상 Azure VM에서 고급 보안을 갖춘 Windows 방화벽 구성

1. 피어링된 가상 네트워크 간의 서비스 체인 테스트


#### 작업 1: 대상 Azure VM에서 고급 보안을 갖춘 Windows 방화벽 구성

1. Azure 포털에서 **az1000401-vm1** Azure VM의 블레이드로 이동합니다. 

1. **az1000401-vm1** 블레이드의 **개요** 창에서 RDP 파일을 생성하고 **az1000401-vm1** 에 연결하는 데 사용합니다.

1. 메시지가 표시되면 다음 자격 증명을 지정하여 인증합니다:

    - 사용자 이름: **Student**

    - 암호: **Pa55w.rd1234**

1. 원격 데스크톱 세션 내에서 **az1000401-vm1** 로 고급 보안 콘솔을 사용하여 **Windows 방화벽** 을 열고 모든 프로필에대해 **파일 및 프린터 공유(에코 요청 - ICMPv4-In)** 인바운드 규칙을 사용하도록 설정합니다.


#### 작업 2: 피어링된 가상 네트워크 간의 서비스 체인 테스트
  
1. Azure 포털에서 **az1000402-vm3** Azure VM의 블레이드로 이동합니다. 

1. **az1000402-vm3** 블레이드의 **개요** 창에서 RDP 파일을 생성하고 **az1000402-vm3** 에 연결하는 데 사용합니다.

1. 메시지가 표시되면 다음 자격 증명을 지정하여 인증합니다:

    - 사용자 이름: **Student**

    - 암호: **Pa55w.rd1234**

1. 원격 데스크톱 세션을 통해 **az1-1000402-vm3** 에 연결되면 **Windows PowerShell** 을 시작합니다.

1. **Windows PowerShell** 창에서 다음을 실행합니다.

   ```powershell
   Test-NetConnection -ComputerName 10.104.0.4 -TraceRoute
   ```

   > **참고**: **10.104.0.4는** 첫 번째 Azure VM **az1000401-vm1** 의 네트워크 인터페이스의 IP 주소입니다.

1. 테스트가 성공했는지 확인하고 연결이 **10.104.1.4** 를 초과하여 라우팅되었는지 확인합니다.

   > **참고**: 사용자 지정 라우팅이 없으면 트래픽이 두 Azure VM 간에 직접 흐르게 됩니다. 
> **결과**: 이 연습을 완료한 후 피어링된 Azure 가상 네트워크 간에 서비스 체인의 유효성을 검사했습니다.


### 연습 4: 랩 리소스 삭제

#### 작업 1: Cloud Shell 열기

1. Azure 포털 상단에서 **Cloud Shell** 아이콘을 클릭하여 Cloud Shell 창을 엽니다.

1. Cloud Shell 인터페이스에서 **Bash**를 선택합니다.

1. **Cloud Shell** 명령 프롬프트에서 다음 명령을 입력하고 **Enter**를 눌러 이 랩에서 생성한 모든 리소스 그룹을 나열합니다.

   ```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv
   ```

1. 출력된 결과가 이 랩에서 생성한 리소스 그룹만 포함되어 있는지 확인합니다. 이 그룹은 다음 작업에서 삭제됩니다.

#### 작업 2: 리소스 그룹 삭제하기

1. **Cloud Shell** 명령 프롬프트에서 다음 명령을 입력하고 **Enter**를 눌러 이 랩에서 생성한 모든 리소스 그룹을 삭제합니다.

   ```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
   ```

1. **Cloud Shell** 명령 프롬프트를 닫습니다.

> **결과**: 이 연습을 완료한 후 이 랩에서 사용된 리소스 그룹을 제거했습니다.
